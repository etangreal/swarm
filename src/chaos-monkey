#!/usr/bin/env nodejs

// ------------------------------------------------------------------------------------------------
// IMPORTS
// ------------------------------------------------------------------------------------------------

var execSync = require('child_process').execSync;

// ------------------------------------------------------------------------------------------------
// DECLARATIONS
// ------------------------------------------------------------------------------------------------

var args = process.argv.slice(2);

// ------------------------------------------------------------------------------------------------
// FUNCTIONS
// ------------------------------------------------------------------------------------------------

var shell = function(cmd) {
	var code = execSync(cmd, { encoding: 'utf8' });
	// console.log(code);
	return code;
}

// ------------------------------------------------------------------------------------------------

var killall = function() {
	shell('docker stop $(docker ps -a -q)');
	shell('docker rm -f $(docker ps -a -q)');
}

// ------------------------------------------------------------------------------------------------

var docker_ps = function() {
	console.log( shell('docker ps -a') );
}

// ------------------------------------------------------------------------------------------------

var compareIPs = function(a,b) {
	var as = a.ip.split('.');
	var bs = b.ip.split('.');

	if ( parseInt(as[0]) < parseInt(bs[0]) ) return -1;
	if ( parseInt(as[0]) > parseInt(bs[0]) ) return 1;

	if ( parseInt(as[1]) < parseInt(bs[1]) ) return -1;
	if ( parseInt(as[1]) > parseInt(bs[1]) ) return 1;

	if ( parseInt(as[2]) < parseInt(bs[2]) ) return -1;
	if ( parseInt(as[2]) > parseInt(bs[2]) ) return 1;

	if ( parseInt(as[3]) < parseInt(bs[3]) ) return -1;
	if ( parseInt(as[3]) > parseInt(bs[3]) ) return 1;

	return 0;
}

// ------------------------------------------------------------------------------------------------

var docker_ps_get_names = function() {

	names = []
	var code = shell('docker ps -a')
	var lines = code.split('\n')
	// console.log(lines)

	var table = []
	for(var i=1; i<lines.length-1; i++) {
		var row = {
			id: lines[i].slice(0, 20).trim(),
			image: lines[i].slice(20, 40).trim(),
			command: lines[i].slice(40, 60).trim(),
			created: lines[i].slice(60, 80).trim(),
			status: lines[i].slice(80, 100).trim(),
			port: lines[i].slice(100, 120).trim(),
			name: lines[i].slice(120, 140).trim()
		}

		table.push(row);
		names.push(row.name);
	}

	// console.log(table)
	// console.log(lines)

	return names;
}

// ------------------------------------------------------------------------------------------------

var lookup = function(names) {
	names = names || [];
	var containers = [];

	for(var i=0; i<names.length; i++) {
		var name = names[i];

		ip = shell('docker inspect --format "{{ .NetworkSettings.IPAddress }}" ' + name);
		ip = ip.replace('\n','')

		containers[i] = {
			name: name,
			ip: ip
		}
	}

	// console.log(containers);
	return containers;
}

// ------------------------------------------------------------------------------------------------

var start = function(names) {
	for(var i=0; i<names.length; i++) {
		var name = names[i];
		shell('docker run -d -i -t --name '+name+' -h '+name+' ubuntu /bin/bash -l')
	}
}

// ------------------------------------------------------------------------------------------------

var config_fast = function() {
	console.log('\n Fast: All containers can talk to all others\n')
	shell('sudo iptables -F DOCKER')

	console.log('\n-------------------------------------------------------------------------------------')
	console.log(shell('sudo iptables -L -v') )
	console.log('-------------------------------------------------------------------------------------\n')
}

// ------------------------------------------------------------------------------------------------

var config_netsplit = function(list) {
	console.log('\nNetsplit: Configured containers are split into two groups: a majority and a minority\n')

	list.sort(compareIPs);

	var out = []
	var len = list.length;
	var div = Math.floor(len/2);

	if (len < 3) {
		console.log('config_netsplit: too few containers to netsplit on...');
		return;
	}

	var first 	= list[0];
	var mid   	= list[div];
	var second 	= list[div+1];
	var last 	= list[len-1];

	// --------------------------------------------------------------------------------------------

	for(var i=0; i<=div; i++) {
		out.push( list[i].name + ' ( ' + list[i].ip + ' )' )
	}
	out.push( 'Connected range: ( ' + first.ip + ' <=> ' + mid.ip + ' )\n' )

	for(var i=div+1; i<len; i++) {
		out.push( list[i].name + ' ( ' + list[i].ip + ' )' )
	}
	out.push( 'Connected range: ( ' + second.ip + ' <=> ' + last.ip + ' )\n' )

	out.forEach(function(line) { 
		console.log('\t' + line)
	})

	// --------------------------------------------------------------------------------------------

	shell('sudo iptables -F DOCKER')

	shell('sudo iptables -A DOCKER -m iprange --src-range '+first.ip+'-'+mid.ip+' -m iprange --dst-range '+first.ip+'-'+mid.ip+' -j ACCEPT')
	shell('sudo iptables -A DOCKER -m iprange --src-range '+second.ip+'-'+last.ip+' -m iprange --dst-range '+second.ip+'-'+last.ip+' -j ACCEPT')
	shell('sudo iptables -A DOCKER -s 172.17.0.0/16 -d 172.17.0.0/16 -j DROP')

	console.log('\n-------------------------------------------------------------------------------------')
	console.log(shell('sudo iptables -L -v') )
	console.log('-------------------------------------------------------------------------------------\n')
}

// ------------------------------------------------------------------------------------------------

var config_bridge = function(list) {
	console.log('\nBridge: Configure containers so that they are split into two groups (a majority and a minority), but one node can see both groups\n')

	list.sort(compareIPs);

	var out = []
	var len = list.length;
	var div = Math.floor(len/2);

	if (len < 3) {
		console.log('config_netsplit: too few containers to netsplit on...');
		return;
	}

	var first 	= list[0];
	var mid   	= list[div];
	var second 	= list[div+1];
	var last 	= list[len-1];

	// --------------------------------------------------------------------------------------------

	for(var i=0; i<=div; i++) {
		out.push( list[i].name + ' ( ' + list[i].ip + ' )' )
	}
	out.push( 'Connected range: ( ' + first.ip + ' <=> ' + mid.ip + ' )\n' )

	out.push( mid.name + ' ( ' + mid.ip + ' => ' + first.ip + ' - ' + last.ip + ' )' )
	out.push( mid.name + ' ( ' + first.ip + ' - ' + last.ip + ' => ' + mid.ip + ' )\n' )

	for(var i=div+1; i<len; i++) {
		out.push( list[i].name + ' ( ' + list[i].ip + ' )' )
	}
	out.push( 'Connected range: ( ' + second.ip + ' <=> ' + last.ip + ' )\n' )

	out.forEach(function(line) { 
		console.log('\t' + line)
	})

	// --------------------------------------------------------------------------------------------

	shell('sudo iptables -F DOCKER')

	shell('sudo iptables -A DOCKER -m iprange --src-range '+first.ip+'-'+mid.ip+' -m iprange --dst-range '+first.ip+'-'+mid.ip+' -j ACCEPT')
	shell('sudo iptables -A DOCKER -s '+mid.ip+' -m iprange --dst-range '+first.ip+'-'+last.ip+' -j ACCEPT')
	
	shell('sudo iptables -A DOCKER -m iprange --src-range '+second.ip+'-'+last.ip+' -m iprange --dst-range '+second.ip+'-'+last.ip+' -j ACCEPT')
	shell('sudo iptables -A DOCKER -m iprange --src-range '+first.ip+'-'+last.ip+' -d '+mid.ip+' -j ACCEPT')

	shell('sudo iptables -A DOCKER -s 172.17.0.0/16 -d 172.17.0.0/16 -j DROP')

	console.log('\n-------------------------------------------------------------------------------------')
	console.log(shell('sudo iptables -L -v') )
	console.log('-------------------------------------------------------------------------------------\n')
}

// ------------------------------------------------------------------------------------------------

var config_ring = function(list) {
	console.log('\nRing: Each container can only see two other containers\n')
	
	list.sort(compareIPs);

	var out = []
	var cmds = []

	for(var i=0; i<list.length-1; i++) {
		var curr = list[i]
		var next = list[i+1]

		out.push( curr.name + ' => ' + next.name + ' ( ' + curr.ip + ' => ' + next.ip + ' )' )
		out.push( next.name + ' => ' + curr.name + ' ( ' + next.ip + ' => ' + next.ip + ' )' )

		cmds.push('sudo iptables -A DOCKER -s '+curr.ip+' -d '+next.ip+' -j ACCEPT')
		cmds.push('sudo iptables -A DOCKER -s '+next.ip+' -d '+curr.ip+' -j ACCEPT')
	}

	if (list.length > 1) {
		var first = list[0];
		var last = list[list.length-1];

		out.push( first.name + ' => ' + last.name + ' ( ' + first.ip + ' => ' + last.ip + ' )' )
		out.push( last.name + ' => ' + first.name + ' ( ' + last.ip + ' => ' + first.ip + ' )' )

		cmds.push('sudo iptables -A DOCKER -s '+first.ip+' -d '+last.ip+' -j ACCEPT')
		cmds.push('sudo iptables -A DOCKER -s '+last.ip+' -d '+first.ip+' -j ACCEPT')
	}

	// --------------------------------------------------------------------------------------------

	out.forEach(function(line) { 
		console.log('\t' + line)
	})

	shell('sudo iptables -F DOCKER')

	cmds.forEach(function(cmd) { 
		shell(cmd) 
	})

	shell('sudo iptables -A DOCKER -s 172.17.0.0/16 -d 172.17.0.0/16 -j DROP')

	console.log('\n-------------------------------------------------------------------------------------')
	console.log(shell('sudo iptables -L -v') )
	console.log('-------------------------------------------------------------------------------------\n')

}//config_ring

// ------------------------------------------------------------------------------------------------
// MAIN: Parse Arguments
// ------------------------------------------------------------------------------------------------

var default_names = ["aa","bb","cc","dd"];

switch(args[0]) {
	case 'names':
		console.log( docker_ps_get_names() )
		break;

	case 'start':
		console.log('Start default docker containers\n')
		var names = docker_ps_get_names()
		if ( names.length > 1 ) {
			console.log('There are already containers running...')
			console.log( lookup(names) )
			docker_ps()
			break;
		}

		start(default_names)
		docker_ps()
		break;

	case 'stop':
		console.log('\nStopped all docker containers\n')
		killall()
		docker_ps()
		break;

	case 'fast':
		config_fast()
		break;

	case 'netsplit':
		var names = docker_ps_get_names()
		var containers = lookup(names)
		config_netsplit(containers);
		break;

	case 'bridge':
		var names = docker_ps_get_names()
		var containers = lookup(names)
		config_bridge(containers);
		break;

	case 'ring':
		var names = docker_ps_get_names()
		var containers = lookup(names)
		config_ring(containers)
		break;

	default:
		console.log('\t./chaos-monkey names 	- will will give a list of the names of running docker cointainers')
		console.log('\t./chaos-monkey start 	- will start a default set of docker containers named "aa", "bb", "cc", "dd"')
		console.log('\t./chaos-monkey start a1 b2 c3 d4 - will start a set of docker containers named "a1", "b2", "c3", "d1"')
		console.log('\t./chaos-monkey stop 		- will kill all currently running docker containers and remove the images\n')

		console.log('\t./chaos-monkey fast 	 	- will configure all containers so that they can talk to each other')
		console.log('\t./chaos-monkey netsplit 	 	- will configure containers so that they are split into two groups: a majority and a minority')
		console.log('\t./chaos-monkey bridge 	 	- same as Netsplit, but one node can see both groups')
		console.log('\t./chaos-monkey ring 	 	- each container can only see two other containers')
		break;
}

// ------------------------------------------------------------------------------------------------
// END
// ------------------------------------------------------------------------------------------------
